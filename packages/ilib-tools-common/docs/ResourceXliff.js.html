<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>ResourceXliff.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Location.html">Location</a><ul class='methods'><li data-type='method'><a href="Location.html#getLocation">getLocation</a></li></ul></li><li><a href="Resource.html">Resource</a><ul class='methods'><li data-type='method'><a href="Resource.html#addInstance">addInstance</a></li><li data-type='method'><a href="Resource.html#clearDirty">clearDirty</a></li><li data-type='method'><a href="Resource.html#escapeText">escapeText</a></li><li data-type='method'><a href="Resource.html#getAutoKey">getAutoKey</a></li><li data-type='method'><a href="Resource.html#getComment">getComment</a></li><li data-type='method'><a href="Resource.html#getContext">getContext</a></li><li data-type='method'><a href="Resource.html#getDNT">getDNT</a></li><li data-type='method'><a href="Resource.html#getDataType">getDataType</a></li><li data-type='method'><a href="Resource.html#getFlavor">getFlavor</a></li><li data-type='method'><a href="Resource.html#getId">getId</a></li><li data-type='method'><a href="Resource.html#getInstances">getInstances</a></li><li data-type='method'><a href="Resource.html#getKey">getKey</a></li><li data-type='method'><a href="Resource.html#getLocalize">getLocalize</a></li><li data-type='method'><a href="Resource.html#getLocation">getLocation</a></li><li data-type='method'><a href="Resource.html#getOrigin">getOrigin</a></li><li data-type='method'><a href="Resource.html#getPath">getPath</a></li><li data-type='method'><a href="Resource.html#getProject">getProject</a></li><li data-type='method'><a href="Resource.html#getSource">getSource</a></li><li data-type='method'><a href="Resource.html#getSourceLocale">getSourceLocale</a></li><li data-type='method'><a href="Resource.html#getState">getState</a></li><li data-type='method'><a href="Resource.html#getTarget">getTarget</a></li><li data-type='method'><a href="Resource.html#getTargetLocale">getTargetLocale</a></li><li data-type='method'><a href="Resource.html#getType">getType</a></li><li data-type='method'><a href="Resource.html#isDirty">isDirty</a></li><li data-type='method'><a href="Resource.html#isInstance">isInstance</a></li><li data-type='method'><a href="Resource.html#same">same</a></li><li data-type='method'><a href="Resource.html#setComment">setComment</a></li><li data-type='method'><a href="Resource.html#setDNT">setDNT</a></li><li data-type='method'><a href="Resource.html#setProject">setProject</a></li><li data-type='method'><a href="Resource.html#setSourceLocale">setSourceLocale</a></li><li data-type='method'><a href="Resource.html#setState">setState</a></li><li data-type='method'><a href="Resource.html#setTargetLocale">setTargetLocale</a></li></ul></li><li><a href="ResourceArray.html">ResourceArray</a><ul class='methods'><li data-type='method'><a href="ResourceArray.html#addInstance">addInstance</a></li><li data-type='method'><a href="ResourceArray.html#addSourceItem">addSourceItem</a></li><li data-type='method'><a href="ResourceArray.html#addTargetItem">addTargetItem</a></li><li data-type='method'><a href="ResourceArray.html#cleanHashKey">cleanHashKey</a></li><li data-type='method'><a href="ResourceArray.html#cleanHashKeyForTranslation">cleanHashKeyForTranslation</a></li><li data-type='method'><a href="ResourceArray.html#clearDirty">clearDirty</a></li><li data-type='method'><a href="ResourceArray.html#clone">clone</a></li><li data-type='method'><a href="ResourceArray.html#equals">equals</a></li><li data-type='method'><a href="ResourceArray.html#equals">equals</a></li><li data-type='method'><a href="ResourceArray.html#escapeText">escapeText</a></li><li data-type='method'><a href="ResourceArray.html#getAutoKey">getAutoKey</a></li><li data-type='method'><a href="ResourceArray.html#getComment">getComment</a></li><li data-type='method'><a href="ResourceArray.html#getContext">getContext</a></li><li data-type='method'><a href="ResourceArray.html#getDNT">getDNT</a></li><li data-type='method'><a href="ResourceArray.html#getDataType">getDataType</a></li><li data-type='method'><a href="ResourceArray.html#getFlavor">getFlavor</a></li><li data-type='method'><a href="ResourceArray.html#getId">getId</a></li><li data-type='method'><a href="ResourceArray.html#getInstances">getInstances</a></li><li data-type='method'><a href="ResourceArray.html#getKey">getKey</a></li><li data-type='method'><a href="ResourceArray.html#getLocalize">getLocalize</a></li><li data-type='method'><a href="ResourceArray.html#getLocation">getLocation</a></li><li data-type='method'><a href="ResourceArray.html#getOrigin">getOrigin</a></li><li data-type='method'><a href="ResourceArray.html#getPath">getPath</a></li><li data-type='method'><a href="ResourceArray.html#getProject">getProject</a></li><li data-type='method'><a href="ResourceArray.html#getSource">getSource</a></li><li data-type='method'><a href="ResourceArray.html#getSourceArray">getSourceArray</a></li><li data-type='method'><a href="ResourceArray.html#getSourceItem">getSourceItem</a></li><li data-type='method'><a href="ResourceArray.html#getSourceLocale">getSourceLocale</a></li><li data-type='method'><a href="ResourceArray.html#getState">getState</a></li><li data-type='method'><a href="ResourceArray.html#getTarget">getTarget</a></li><li data-type='method'><a href="ResourceArray.html#getTargetArray">getTargetArray</a></li><li data-type='method'><a href="ResourceArray.html#getTargetItem">getTargetItem</a></li><li data-type='method'><a href="ResourceArray.html#getTargetLocale">getTargetLocale</a></li><li data-type='method'><a href="ResourceArray.html#getType">getType</a></li><li data-type='method'><a href="ResourceArray.html#hashKey">hashKey</a></li><li data-type='method'><a href="ResourceArray.html#hashKeyForTranslation">hashKeyForTranslation</a></li><li data-type='method'><a href="ResourceArray.html#isDirty">isDirty</a></li><li data-type='method'><a href="ResourceArray.html#isInstance">isInstance</a></li><li data-type='method'><a href="ResourceArray.html#same">same</a></li><li data-type='method'><a href="ResourceArray.html#setComment">setComment</a></li><li data-type='method'><a href="ResourceArray.html#setDNT">setDNT</a></li><li data-type='method'><a href="ResourceArray.html#setProject">setProject</a></li><li data-type='method'><a href="ResourceArray.html#setSource">setSource</a></li><li data-type='method'><a href="ResourceArray.html#setSourceLocale">setSourceLocale</a></li><li data-type='method'><a href="ResourceArray.html#setState">setState</a></li><li data-type='method'><a href="ResourceArray.html#setTarget">setTarget</a></li><li data-type='method'><a href="ResourceArray.html#setTargetLocale">setTargetLocale</a></li><li data-type='method'><a href="ResourceArray.html#size">size</a></li><li data-type='method'><a href="ResourceArray.html#.hashKey">hashKey</a></li></ul></li><li><a href="ResourcePlural.html">ResourcePlural</a><ul class='methods'><li data-type='method'><a href="ResourcePlural.html#addInstance">addInstance</a></li><li data-type='method'><a href="ResourcePlural.html#addSourcePlural">addSourcePlural</a></li><li data-type='method'><a href="ResourcePlural.html#addTargetPlural">addTargetPlural</a></li><li data-type='method'><a href="ResourcePlural.html#cleanHashKey">cleanHashKey</a></li><li data-type='method'><a href="ResourcePlural.html#cleanHashKeyForTranslation">cleanHashKeyForTranslation</a></li><li data-type='method'><a href="ResourcePlural.html#clearDirty">clearDirty</a></li><li data-type='method'><a href="ResourcePlural.html#clone">clone</a></li><li data-type='method'><a href="ResourcePlural.html#equals">equals</a></li><li data-type='method'><a href="ResourcePlural.html#escapeText">escapeText</a></li><li data-type='method'><a href="ResourcePlural.html#getAllValidCategories">getAllValidCategories</a></li><li data-type='method'><a href="ResourcePlural.html#getAutoKey">getAutoKey</a></li><li data-type='method'><a href="ResourcePlural.html#getCategories">getCategories</a></li><li data-type='method'><a href="ResourcePlural.html#getClasses">getClasses</a></li><li data-type='method'><a href="ResourcePlural.html#getComment">getComment</a></li><li data-type='method'><a href="ResourcePlural.html#getContext">getContext</a></li><li data-type='method'><a href="ResourcePlural.html#getDNT">getDNT</a></li><li data-type='method'><a href="ResourcePlural.html#getDataType">getDataType</a></li><li data-type='method'><a href="ResourcePlural.html#getFlavor">getFlavor</a></li><li data-type='method'><a href="ResourcePlural.html#getId">getId</a></li><li data-type='method'><a href="ResourcePlural.html#getInstances">getInstances</a></li><li data-type='method'><a href="ResourcePlural.html#getKey">getKey</a></li><li data-type='method'><a href="ResourcePlural.html#getLocalize">getLocalize</a></li><li data-type='method'><a href="ResourcePlural.html#getLocation">getLocation</a></li><li data-type='method'><a href="ResourcePlural.html#getOrigin">getOrigin</a></li><li data-type='method'><a href="ResourcePlural.html#getPath">getPath</a></li><li data-type='method'><a href="ResourcePlural.html#getProject">getProject</a></li><li data-type='method'><a href="ResourcePlural.html#getSource">getSource</a></li><li data-type='method'><a href="ResourcePlural.html#getSourceLocale">getSourceLocale</a></li><li data-type='method'><a href="ResourcePlural.html#getSourcePlural">getSourcePlural</a></li><li data-type='method'><a href="ResourcePlural.html#getSourcePlurals">getSourcePlurals</a></li><li data-type='method'><a href="ResourcePlural.html#getSourceStrings">getSourceStrings</a></li><li data-type='method'><a href="ResourcePlural.html#getState">getState</a></li><li data-type='method'><a href="ResourcePlural.html#getTarget">getTarget</a></li><li data-type='method'><a href="ResourcePlural.html#getTargetLocale">getTargetLocale</a></li><li data-type='method'><a href="ResourcePlural.html#getTargetPlural">getTargetPlural</a></li><li data-type='method'><a href="ResourcePlural.html#getTargetPlurals">getTargetPlurals</a></li><li data-type='method'><a href="ResourcePlural.html#getTargetStrings">getTargetStrings</a></li><li data-type='method'><a href="ResourcePlural.html#getType">getType</a></li><li data-type='method'><a href="ResourcePlural.html#hashKey">hashKey</a></li><li data-type='method'><a href="ResourcePlural.html#hashKeyForTranslation">hashKeyForTranslation</a></li><li data-type='method'><a href="ResourcePlural.html#isDirty">isDirty</a></li><li data-type='method'><a href="ResourcePlural.html#isInstance">isInstance</a></li><li data-type='method'><a href="ResourcePlural.html#same">same</a></li><li data-type='method'><a href="ResourcePlural.html#setComment">setComment</a></li><li data-type='method'><a href="ResourcePlural.html#setDNT">setDNT</a></li><li data-type='method'><a href="ResourcePlural.html#setProject">setProject</a></li><li data-type='method'><a href="ResourcePlural.html#setSource">setSource</a></li><li data-type='method'><a href="ResourcePlural.html#setSourceLocale">setSourceLocale</a></li><li data-type='method'><a href="ResourcePlural.html#setState">setState</a></li><li data-type='method'><a href="ResourcePlural.html#setTarget">setTarget</a></li><li data-type='method'><a href="ResourcePlural.html#setTargetLocale">setTargetLocale</a></li><li data-type='method'><a href="ResourcePlural.html#size">size</a></li><li data-type='method'><a href="ResourcePlural.html#.hashKey">hashKey</a></li></ul></li><li><a href="ResourceString.html">ResourceString</a><ul class='methods'><li data-type='method'><a href="ResourceString.html#addInstance">addInstance</a></li><li data-type='method'><a href="ResourceString.html#cleanHashKey">cleanHashKey</a></li><li data-type='method'><a href="ResourceString.html#cleanHashKeyForTranslation">cleanHashKeyForTranslation</a></li><li data-type='method'><a href="ResourceString.html#clearDirty">clearDirty</a></li><li data-type='method'><a href="ResourceString.html#clone">clone</a></li><li data-type='method'><a href="ResourceString.html#equals">equals</a></li><li data-type='method'><a href="ResourceString.html#escapeText">escapeText</a></li><li data-type='method'><a href="ResourceString.html#getAutoKey">getAutoKey</a></li><li data-type='method'><a href="ResourceString.html#getComment">getComment</a></li><li data-type='method'><a href="ResourceString.html#getContext">getContext</a></li><li data-type='method'><a href="ResourceString.html#getDNT">getDNT</a></li><li data-type='method'><a href="ResourceString.html#getDataType">getDataType</a></li><li data-type='method'><a href="ResourceString.html#getFlavor">getFlavor</a></li><li data-type='method'><a href="ResourceString.html#getId">getId</a></li><li data-type='method'><a href="ResourceString.html#getInstances">getInstances</a></li><li data-type='method'><a href="ResourceString.html#getKey">getKey</a></li><li data-type='method'><a href="ResourceString.html#getLocalize">getLocalize</a></li><li data-type='method'><a href="ResourceString.html#getLocation">getLocation</a></li><li data-type='method'><a href="ResourceString.html#getOrigin">getOrigin</a></li><li data-type='method'><a href="ResourceString.html#getPath">getPath</a></li><li data-type='method'><a href="ResourceString.html#getProject">getProject</a></li><li data-type='method'><a href="ResourceString.html#getSource">getSource</a></li><li data-type='method'><a href="ResourceString.html#getSourceLocale">getSourceLocale</a></li><li data-type='method'><a href="ResourceString.html#getState">getState</a></li><li data-type='method'><a href="ResourceString.html#getTarget">getTarget</a></li><li data-type='method'><a href="ResourceString.html#getTargetLocale">getTargetLocale</a></li><li data-type='method'><a href="ResourceString.html#getType">getType</a></li><li data-type='method'><a href="ResourceString.html#hashKey">hashKey</a></li><li data-type='method'><a href="ResourceString.html#hashKeyForTranslation">hashKeyForTranslation</a></li><li data-type='method'><a href="ResourceString.html#isDirty">isDirty</a></li><li data-type='method'><a href="ResourceString.html#isInstance">isInstance</a></li><li data-type='method'><a href="ResourceString.html#same">same</a></li><li data-type='method'><a href="ResourceString.html#setComment">setComment</a></li><li data-type='method'><a href="ResourceString.html#setDNT">setDNT</a></li><li data-type='method'><a href="ResourceString.html#setProject">setProject</a></li><li data-type='method'><a href="ResourceString.html#setSource">setSource</a></li><li data-type='method'><a href="ResourceString.html#setSourceLocale">setSourceLocale</a></li><li data-type='method'><a href="ResourceString.html#setState">setState</a></li><li data-type='method'><a href="ResourceString.html#setTarget">setTarget</a></li><li data-type='method'><a href="ResourceString.html#setTargetLocale">setTargetLocale</a></li><li data-type='method'><a href="ResourceString.html#size">size</a></li><li data-type='method'><a href="ResourceString.html#.cleanHashKey">cleanHashKey</a></li><li data-type='method'><a href="ResourceString.html#.hashKey">hashKey</a></li></ul></li><li><a href="ResourceXliff.html">ResourceXliff</a><ul class='methods'><li data-type='method'><a href="ResourceXliff.html#getLines">getLines</a></li><li data-type='method'><a href="ResourceXliff.html#getVersion">getVersion</a></li><li data-type='method'><a href="ResourceXliff.html#size">size</a></li></ul></li><li><a href="TranslationSet.html">TranslationSet</a><ul class='methods'><li data-type='method'><a href="TranslationSet.html#add">add</a></li><li data-type='method'><a href="TranslationSet.html#addAll">addAll</a></li><li data-type='method'><a href="TranslationSet.html#addSet">addSet</a></li><li data-type='method'><a href="TranslationSet.html#clear">clear</a></li><li data-type='method'><a href="TranslationSet.html#diff">diff</a></li><li data-type='method'><a href="TranslationSet.html#get">get</a></li><li data-type='method'><a href="TranslationSet.html#getAll">getAll</a></li><li data-type='method'><a href="TranslationSet.html#getBy">getBy</a></li><li data-type='method'><a href="TranslationSet.html#getBySource">getBySource</a></li><li data-type='method'><a href="TranslationSet.html#getClean">getClean</a></li><li data-type='method'><a href="TranslationSet.html#getContexts">getContexts</a></li><li data-type='method'><a href="TranslationSet.html#getLocales">getLocales</a></li><li data-type='method'><a href="TranslationSet.html#getProjects">getProjects</a></li><li data-type='method'><a href="TranslationSet.html#isDirty">isDirty</a></li><li data-type='method'><a href="TranslationSet.html#remove">remove</a></li><li data-type='method'><a href="TranslationSet.html#setClean">setClean</a></li><li data-type='method'><a href="TranslationSet.html#size">size</a></li></ul></li><li><a href="TranslationUnit.html">TranslationUnit</a><ul class='methods'><li data-type='method'><a href="TranslationUnit.html#addProperties">addProperties</a></li><li data-type='method'><a href="TranslationUnit.html#addVariant">addVariant</a></li><li data-type='method'><a href="TranslationUnit.html#addVariants">addVariants</a></li><li data-type='method'><a href="TranslationUnit.html#clone">clone</a></li><li data-type='method'><a href="TranslationUnit.html#getProperties">getProperties</a></li><li data-type='method'><a href="TranslationUnit.html#getVariants">getVariants</a></li><li data-type='method'><a href="TranslationUnit.html#hashKey">hashKey</a></li></ul></li><li><a href="TranslationVariant.html">TranslationVariant</a><ul class='methods'><li data-type='method'><a href="TranslationVariant.html#hashKey">hashKey</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#cleanString">cleanString</a></li><li><a href="global.html#containsActualText">containsActualText</a></li><li><a href="global.html#formatPath">formatPath</a></li><li><a href="global.html#getLocaleFromPath">getLocaleFromPath</a></li><li><a href="global.html#hashKey">hashKey</a></li><li><a href="global.html#ignoreTags">ignoreTags</a></li><li><a href="global.html#isEmpty">isEmpty</a></li><li><a href="global.html#localizableAttributes">localizableAttributes</a></li><li><a href="global.html#nonBreakingTags">nonBreakingTags</a></li><li><a href="global.html#objectMap">objectMap</a></li><li><a href="global.html#parsePath">parsePath</a></li><li><a href="global.html#selfClosingTags">selfClosingTags</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">ResourceXliff.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Xliff.js - convert an Xliff file into a set of resources and vice versa
 *
 * Copyright © 2022-2023 JEDLSoft
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { Xliff, TranslationUnit } from 'ilib-xliff';
import log4js from "@log4js-node/log4js-api";

import ResourceString from './ResourceString.js';
import ResourceArray from './ResourceArray.js';
import ResourcePlural from './ResourcePlural.js';
import TranslationSet from './TranslationSet.js';
import Location from './Location.js';

import { isEmpty } from './utils.js';

const logger = log4js.getLogger("tools-common.ResourceXliff");

function generatePluralComment(res, sourcePlurals, form) {
    var json = {};

    if (res.comment) {
        try {
            // see if its json already. If so, we'll add to it
            json = JSON.parse(res.comment);
        } catch (e) {
            // not json, so just return it as is
            return res.comment;
        }
    }

    json.pluralForm = form;
    json.pluralFormOther = res.getKey();

    return JSON.stringify(json);
}

/**
 * @class a class that represents resources as an xliff file.
 */
class ResourceXliff {
    /**
     * Construct a new resource xliff instance. Operation of the instance
     * is controlled via the options. The options may be undefined, which represents a new,
     * clean Xliff instance. The options object may also
     * be an object with the following properties:
     *
     * &lt;ul>
     * &lt;li>&lt;i>path&lt;/i> - the path to the xliff file on disk
     * &lt;li>&lt;i>tool-id&lt;/i> - the id of the tool that saved this xliff file
     * &lt;li>&lt;i>tool-name&lt;/i> - the full name of the tool that saved this xliff file
     * &lt;li>&lt;i>tool-version&lt;/i> - the version of the tool that save this xliff file
     * &lt;li>&lt;i>tool-company&lt;/i> - the name of the company that made this tool
     * &lt;li>&lt;i>copyright&lt;/i> - a copyright notice that you would like included into the xliff file
     * &lt;li>&lt;i>sourceLocale&lt;/i> - specify the default source locale if a resource doesn't have a locale itself
     * &lt;li>&lt;i>allowDups&lt;/i> - allow duplicate resources in the xliff. By default, dups are
     * filtered out. This option allows you to have trans-units that represent instances of the
     * same resource in the file with different metadata. For example, two instances of a
     * resource may have different comments which may both be useful to translators or
     * two instances of the same resource may have been extracted from different source files.
     * &lt;li>&lt;i>version&lt;/i> - The version of xliff that will be produced by this instance. This
     * may be either "1.2" or "2.0"
     * &lt;/ul>
     *
     * @constructor
     * @param {Array.&lt;Object>|undefined} options options to
     * initialize the file, or undefined for a new empty file
     */
    constructor(options) {
        if (options) {
            this["tool-id"] = options["tool-id"];
            this["tool-name"] = options["tool-name"];
            this["tool-version"] = options["tool-version"];
            this["tool-company"] = options["tool-company"];
            this.copyright = options.copyright;
            this.path = options.path;
            this.sourceLocale = options.sourceLocale || "en-US";
            this.project = options.project;
            this.allowDups = options.allowDups;
            this.style =  options.style || "standard";
            if (typeof(options.version) !== 'undefined') {
                this.version = options.version;
            }
        }
        this.sourceLocale = this.sourceLocale || "en-US";

        this.xliff = new Xliff(options);
        this.ts = new TranslationSet(this.sourceLocale);
    }

    /**
     * Convert a resource into one or more translation units.
     *
     * @private
     * @param {Resource} res the resource to convert
     * @returns {Array.&lt;TranslationUnit>} an array of translation units
     * that represent the resource
     */
    convertResource(res) {
        let units = [], tu;

        try {
            switch (res.resType) {
            case "string":
                tu = new TranslationUnit({
                    project: res.project,
                    key: res.getKey(),
                    file: res.getPath(),
                    sourceLocale: res.getSourceLocale(),
                    source: res.getSource(),
                    targetLocale: res.getTargetLocale(),
                    target: res.getTarget(),
                    state: res.getState(),
                    id: res.getId(),
                    translated: true,
                    context: res.context,
                    comment: res.comment,
                    resType: res.resType,
                    datatype: res.datatype,
                    flavor: res.getFlavor ? res.getFlavor() : undefined,
                    translate: !res.getDNT(),
                    location: res.getLocation()
                });
                units.push(tu);
                break;

            case "array":
                const sarr = res.getSource();
                let tarr = res.getTarget();

                tu = new TranslationUnit({
                    project: res.project,
                    key: res.getKey(),
                    file: res.getPath(),
                    source: " ",
                    sourceLocale: res.getSourceLocale(),
                    targetLocale: res.getTargetLocale(),
                    state: res.getState(),
                    id: res.getId(),
                    translated: true,
                    context: res.context,
                    comment: res.comment,
                    resType: res.resType,
                    datatype: res.datatype,
                    flavor: res.getFlavor ? res.getFlavor() : undefined,
                    translate: !res.getDNT(),
                    location: res.getLocation()
                });

                for (let j = 0; j &lt; sarr.length; j++) {
                    // only output array items that have a translation
                    if (sarr[j]) {
                        const newtu = tu.clone();
                        newtu.source = sarr[j];
                        newtu.ordinal = j;

                        if (tarr &amp;&amp; j &lt; tarr.length &amp;&amp; tarr[j]) {
                            newtu.target = tarr[j];
                        }

                        newtu.ordinal = j;
                        units.push(newtu);
                    } else if (tarr[j]) {
                        logger.warn("Translated array  " + res.getKey() + " has no source string at index " + j + ". Cannot translate. Resource is: " + JSON.stringify(res, undefined, 4));
                    }
                }
                break;

            case "plural":
                tu = new TranslationUnit({
                    project: res.project,
                    key: res.getKey(),
                    file: res.getPath(),
                    source: " ",
                    sourceLocale: res.getSourceLocale(),
                    targetLocale: res.getTargetLocale(),
                    state: res.getState(),
                    id: res.getId(),
                    translated: true,
                    context: res.context,
                    resType: res.resType,
                    datatype: res.datatype,
                    flavor: res.getFlavor ? res.getFlavor() : undefined,
                    location: res.getLocation(),
                    translate: !res.getDNT()
                });

                const sp = res.getSource();
                const tp = res.getTarget();

                if (!tp || isEmpty(tp)) {
                    for (let p in sp) {
                        const newtu = tu.clone();
                        newtu.source = sp[p];
                        newtu.quantity = p;
                        newtu.comment = generatePluralComment(res, sp, p);
                        units.push(newtu);
                    }
                } else {
                    for (let p in tp) {
                        const newtu = tu.clone();
                        newtu.source = sp[p] || sp.other;
                        newtu.target = tp[p];
                        newtu.quantity = p;
                        newtu.comment = generatePluralComment(res, sp, p);
                        units.push(newtu);
                    }
                }
                break;
            }
        } catch (e) {
            logger.warn(e);
            logger.warn(JSON.stringify(res));
            logger.warn("Skipping that resource.");
        }

        return units;
    }

    /**
     * Convert a translation unit to a new loctool resource.
     *
     * @private
     * @param {TranslationUnit} tu the translation to convert
     * @return {Resource} the corresponding resource
     */
    convertTransUnit(tu) {
        let res;

        switch (tu.resType) {
        default:
            res = new ResourceString({
                pathName: tu.file,
                project: tu.project,
                id: tu.id,
                key: tu.key,
                sourceLocale: tu.sourceLocale,
                source: tu.source,
                targetLocale: tu.targetLocale,
                context: tu.context,
                comment: tu.comment,
                resType: tu.resType,
                datatype: tu.datatype,
                state: tu.state,
                flavor: tu.flavor,
                location: new Location(tu.location)
            });

            if (tu.target) {
                res.setTarget(tu.target);
            }
            break;

        case "array":
            var arr = [];
            arr[tu.ordinal] = tu.source;
            res = new ResourceArray({
                pathName: tu.file,
                project: tu.project,
                id: tu.id,
                key: tu.key,
                sourceLocale: tu.sourceLocale,
                source: arr,
                targetLocale: tu.targetLocale,
                target: [],
                context: tu.context,
                comment: tu.comment,
                resType: tu.resType,
                datatype: tu.datatype,
                state: tu.state,
                flavor: tu.flavor,
                location: new Location(tu.location)
            });

            if (tu.target) {
                res.addTargetItem(tu.ordinal, tu.target);
            }
            break;

        case "plural":
            var strings = {};
            strings[tu.quantity] = tu.source;
            res = new ResourcePlural({
                pathName: tu.file,
                project: tu.project,
                id: tu.id,
                key: tu.key,
                sourceLocale: tu.sourceLocale,
                source: strings,
                targetLocale: tu.targetLocale,
                target: {},
                context: tu.context,
                comment: tu.comment,
                resType: tu.resType,
                datatype: tu.datatype,
                state: tu.state,
                flavor: tu.flavor,
                location: new Location(tu.location)
            });

            if (tu.target) {
                res.addTargetPlural(tu.quantity, tu.target);
            }
            break;
        }

        if (typeof(tu.translate) === "boolean") {
            res.setDNT(!tu.translate);
        }

        return res;
    }

    getPath() {
        return this.path;
    }

    setPath(newPath) {
        this.path = newPath;
    }

    parse(xml) {
        const tuList = this.xliff.deserialize(xml);
        let res;

        if (tuList) {
            for (var j = 0; j &lt; tuList.length; j++) {
                const tu = tuList[j];
                let comment;

                switch (tu.resType) {
                default:
                    res = this.convertTransUnit(tu);
                    this.ts.add(res);
                    break;

                case "array":
                    res = this.ts.get(ResourceArray.hashKey(tu.project, tu.context, tu.targetLocale || tu.sourceLocale, tu.key));
                    if (res) {
                        // if it already exists, amend the existing resource instead of creating a new one
                        res.addSourceItem(tu.ordinal, tu.source);
                        if (tu.target) {
                            res.addTargetItem(tu.ordinal, tu.target);
                        }
                    } else {
                        res = this.convertTransUnit(tu);
                        this.ts.add(res);
                    }
                    break;

                case "plural":
                    res = this.ts.get(ResourcePlural.hashKey(tu.project, tu.context, tu.targetLocale || tu.sourceLocale, tu.key));
                    if (res) {
                        // if it already exists, amend the existing resource instead of creating a new one
                        res.addSourcePlural(tu.quantity, tu.source);
                        if (tu.target) {
                            res.addTargetPlural(tu.quantity, tu.target);
                        }
                    } else {
                        res = this.convertTransUnit(tu);
                        this.ts.add(res);
                    }
                    break;
                }
            }
        }

        return this.ts;
    }

    getResources(criteria) {
        if (!criteria) return this.ts.getAll();
        return this.ts.getBy(criteria);
    }

    addResource(res) {
        if (!res) return;

        if (res.getTargetLocale() === this.sourceLocale || res.getTargetLocale() === "en") {
            // don't add this one... cannot translate TO the source locale!
            return;
        }

        this.ts.add(res);
    }

    getText() {
        let units = [];

        if (this.ts.size() > 0) {
            // first convert the resources into translation units
            let resources = this.ts.getAll();

            if (this.allowDups) {
                // only look at the initial set of resources
                const initialLength = resources.length;
                for (let i = 0; i &lt; initialLength; i++) {
                    const res = resources[i];
                    const instances = res.getInstances();
                    if (instances &amp;&amp; instances.length) {
                        resources = resources.concat(instances);
                        resources[i].instances = undefined;
                    }
                }
            }
            resources.sort(function(left, right) {
                if (typeof(left.index) === 'number' &amp;&amp; typeof(right.index) === 'number') {
                    return left.index - right.index;
                }
                if (typeof(left.id) === 'number' &amp;&amp; typeof(right.id) === 'number') {
                    return left.id - right.id;
                }
                // no ids and no indexes? Well, then don't rearrange
                return 0;
            });

            // now add the translations
            for (var i = 0; i &lt; resources.length; i++) {
                var res = resources[i];
                if (res.getTargetLocale() !== this.sourceLocale) {
                    units = units.concat(this.convertResource(res));
                }
            }
        }

        // start with no translation units in it
        this.xliff.clear();
        this.xliff.addTranslationUnits(units);

        return this.xliff.serialize(true);
    }

    /**
     * Return the number of lines in the xml representation of this file.
     *
     * @returns {Number} the number of lines in the xml
     */
    getLines() {
        return this.xliff.getLines();
    }

    /**
     * Return the number of resources in this resource xliff file.
     * @returns {Number} the number of resources in this file
     */
    size() {
        return this.ts.size();
    }

    /**
     * Get the version number of this file. Currently, it only supports
     * xliff v1.2 and v2.0.
     * @returns {String} the version number of the file
     */
    getVersion() {
        return this.version;
    }
}

export default ResourceXliff;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Tue Nov 26 2024 16:49:54 GMT+0100 (Central European Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
